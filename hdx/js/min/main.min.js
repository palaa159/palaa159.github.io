function map_range(t,e,r,n,a){return n+(a-n)*(t-e)/(r-e)}var countries,topo,hdx,currentYear,key_year=[],d_min,d_max,tooltip=d3.select("#tooltip").attr({"class":"hidden"}),width=window.innerWidth,height=window.innerHeight,projection=d3.geo.mercator().scale((width+1)/2/Math.PI).translate([width/2,height/2]).precision(.1),path=d3.geo.path().projection(projection),graticule=d3.geo.graticule();queue().defer(d3.json,"data/world-centroid.json").defer(d3.csv,"data/PVH140_Baseline.csv").awaitAll(function(t,e){topo=e[0],countries=e[0].objects.countries.geometries,hdx=e[1],console.info("start combining");for(var r=0;r<hdx.length;r++)for(var n=hdx[r]["Country name"].toLowerCase(),a=0;a<countries.length;a++){var o=countries[a].properties.name.toLowerCase();n===o&&(hdx[r].center=countries[a].properties.center)}for(var i=0;i<hdx.length;i++)"undefined"==typeof hdx[i].center&&hdx.splice(i,1);for(var c=0;c<hdx.length;c++)"object"==typeof hdx[c].center[0]&&hdx.splice(c,1);console.info("all done"),init()});var init=function(){var t=d3.select("#container").append("svg").attr({id:"mapContainer",width:width,height:height}).append("g"),e=t.append("g"),r=t.append("g").attr("id","timeline"),n=function(r){console.log("D3","Drawing the map"),t.append("path").datum(graticule).attr({"class":"graticule",d:path});var n=e.selectAll(".country").data(r);n.enter().insert("path").attr({fill:"#ffffcc",title:function(t){return t.properties.name},"class":"country",d:path,id:function(t){return t.di}})},a=function(r){d3.selectAll(".node").remove(),console.log("D3","Drawing Country Node");var n=e.selectAll(".node").data(hdx);n.enter().insert("circle").attr({cx:function(t){return projection([t.center[1],t.center[0]])[0]},cy:function(t){return projection([t.center[1],t.center[0]])[1]},r:function(t){return map_range(t[currentYear],10,500,5,100)},name:function(t){return t["Country name"]},"class":"node"}).on("mouseover",function(){var e=d3.mouse(t.node()).map(function(t){return parseInt(t)});tooltip.classed("hidden",!1).attr("style","left:"+(e[0]+10)+"px; top:"+(e[1]+30)+"px").html(d3.select(this).attr("name").toLowerCase().capitalize()+", "+d3.select(this).attr("rate"))}).on("mouseout",function(){tooltip.classed("hidden",!0)}).transition().duration(1e3).attr({r:function(t){return map_range(t[r],10,500,5,100)},rate:function(t){return t[r]}})},o=function(r){var n=t.append("svg:defs").append("svg:linearGradient").attr("id","gradient").attr("x1","0%").attr("y1","0%").attr("x2","100%").attr("y2","0%").attr("spreadMethod","pad");n.append("svg:stop").attr("offset","0%").attr("stop-color",d3.hsl(80,.9,.5)).attr("stop-opacity",1),n.append("svg:stop").attr("offset","100%").attr("stop-color",d3.hsl(0,.9,.5)).attr("stop-opacity",1);var a=e.append("g").attr("id","legend");a.append("rect").attr({"class":"heatLegend",x:0,y:0,width:200,height:10}).style("fill","url(#gradient)"),a.append("text").attr({x:-5,y:-5}).text("0"),a.append("text").attr({x:190,y:-5}).text("326"),a.attr({transform:"translate("+(width-200-50)+", "+(height-90)+")"});var o=d3.selectAll(".country");hdx.forEach(function(e){o[0].forEach(function(n){e["Country name"].toLowerCase()===d3.select(n).attr("title").toLowerCase()&&d3.select(n).attr({rate:e[r],fill:function(){var t=e[currentYear];return t=map_range(t,0,326,80,0),d3.hsl(t,.9,.5)}}).on("mouseover",function(){var e=d3.mouse(t.node()).map(function(t){return parseInt(t)});tooltip.classed("hidden",!1).attr("style","left:"+(e[0]+10)+"px; top:"+(e[1]+30)+"px").html(d3.select(this).attr("title").toLowerCase().capitalize()+", "+d3.select(this).attr("rate"))}).on("mouseout",function(){tooltip.classed("hidden",!0)}).transition().duration(500).attr({fill:function(){var t=e[r];return t=map_range(t,0,326,80,0),d3.hsl(t,.9,.5)}})})}),currentYear=r},i=function(){for(var t in hdx[0])parseInt(t)&&key_year.push(t.toString());currentYear=key_year[0]},c=function(){var t=900;r.append("line").attr({"class":"t_line",x1:5,y1:-20,x2:t-5,y2:-20}),key_year.forEach(function(t,e){r.append("circle").attr({"class":"yearDot",cx:40*e+10,cy:-20,r:5,year:t}).on("click",function(){p.stop(),s(d3.select(this).attr("year"))}),r.append("text").attr({"class":"year",x:40*e,y:0}).text(t)}),r.attr("width",t),r.attr("transform","translate("+(width-t-50)+", "+(height-30)+")")},s=function(t){console.log("drawing",t),d3.selectAll(".node").remove(),d3.select("#legend").remove(),d3.selectAll(".yearDot").attr("class","yearDot"),d3.select('[year="'+t+'"]').attr({"class":"yearDot selected"});var e=d3.selectAll(".country");e[0].forEach(function(t){d3.select(t).attr({fill:"#ffffff"}).on("mouseover",function(){})});var r=l.value;"node"===r?a(t):"heat"===r&&o(t),currentYear=t},l=document.getElementById("vizMode"),d=document.getElementById("autoplay"),u=function(t,e){this.delay=t,this.array=e,this.interval=null;var r=e.indexOf(currentYear);return this.start=function(){return this.interval=setInterval(function(){r=e.indexOf(currentYear),r==e.length-1?r=0:r++,console.log(r),s(e[r])},t),this},this.stop=function(){return d.innerText="Autoplay",this.interval&&clearInterval(this.interval),this},this},p=new u(1500,key_year);l.addEventListener("change",function(){console.log(l.value),s(currentYear)}),d.addEventListener("click",function(){"Autoplay"===this.innerText?(p.start(),this.innerText="Stop"):(p.stop(),this.innerText="Autoplay")}),topo=topojson.feature(topo,topo.objects.countries).features,n(topo),i(),c(),d3.select(".yearDot").attr("class","yearDot selected"),s(currentYear)};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};