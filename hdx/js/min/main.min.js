function map_range(t,e,r,n,o){return n+(o-n)*(t-e)/(r-e)}var countries,topo,hdx,currentYear,key_year=[],d_min,d_max,tooltip=d3.select("#tooltip").attr({"class":"hidden"}),width=window.innerWidth,height=window.innerHeight,projection=d3.geo.mercator().scale((width+1)/2/Math.PI).translate([width/2,height/2]).precision(.1),path=d3.geo.path().projection(projection),graticule=d3.geo.graticule();queue().defer(d3.json,"data/world-centroid.json").defer(d3.csv,"data/PVH140_Baseline.csv").awaitAll(function(t,e){topo=e[0],countries=e[0].objects.countries.geometries,hdx=e[1],console.info("start combining");for(var r=0;r<hdx.length;r++)for(var n=hdx[r]["Country name"].toLowerCase(),o=0;o<countries.length;o++){var a=countries[o].properties.name.toLowerCase();n===a&&(hdx[r].center=countries[o].properties.center)}for(var i=0;i<hdx.length;i++)"undefined"==typeof hdx[i].center&&hdx.splice(i,1);for(var c=0;c<hdx.length;c++)"object"==typeof hdx[c].center[0]&&hdx.splice(c,1);console.info("all done"),init()});var init=function(){var t=d3.select("#container").append("svg").attr({id:"mapContainer",width:width,height:height}).append("g"),e=t.append("g"),r=t.append("g").attr("id","timeline"),n=function(r){console.log("D3","Drawing the map"),t.append("path").datum(graticule).attr({"class":"graticule",d:path});var n=e.selectAll(".country").data(r);n.enter().insert("path").attr({title:function(t){return t.properties.name},"class":"country",d:path,id:function(t){return t.di}})},o=function(r){d3.selectAll(".node").remove(),console.log("D3","Drawing Country Node"),console.log(currentYear,r);var n=e.selectAll(".node").data(hdx);n.enter().insert("circle").attr({cx:function(t){return projection([t.center[1],t.center[0]])[0]},cy:function(t){return projection([t.center[1],t.center[0]])[1]},r:function(t){return map_range(t[currentYear],10,500,5,100)},name:function(t){return t["Country name"]},"class":"node"}).on("mouseover",function(){var e=d3.mouse(t.node()).map(function(t){return parseInt(t)});tooltip.classed("hidden",!1).attr("style","left:"+(e[0]+10)+"px; top:"+(e[1]+30)+"px").html(d3.select(this).attr("name").toLowerCase().capitalize()+", "+d3.select(this).attr("rate"))}).on("mouseout",function(){tooltip.classed("hidden",!0)}).transition().duration(1e3).ease("bounce").attr({r:function(t){return map_range(t[r],10,500,5,100)},rate:function(t){return t[r]}}),currentYear=r},a=function(){for(var t in hdx[0])parseInt(t)&&key_year.push(t.toString());currentYear=key_year[0]},i=function(){var t=900;r.append("line").attr({"class":"t_line",x1:5,y1:-20,x2:t-5,y2:-20}),key_year.forEach(function(t,e){r.append("circle").attr({"class":"yearDot",cx:40*e+10,cy:-20,r:5,year:t}).on("click",function(){d3.selectAll(".yearDot").attr("class","yearDot"),d3.select(this).attr("class","yearDot selected"),o(d3.select(this).attr("year"))}),r.append("text").attr({"class":"year",x:40*e,y:0}).text(t)}),r.attr("width",t),r.attr("transform","translate("+(width-t-50)+", "+(height-30)+")")};topo=topojson.feature(topo,topo.objects.countries).features,n(topo),a(),i(),d3.select(".yearDot").attr("class","yearDot selected"),o(currentYear)};String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)};