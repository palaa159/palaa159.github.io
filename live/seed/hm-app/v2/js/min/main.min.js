var app=app||{};app.main=function(){var t,e,n,a,r,i=[],o=[],c=["Category – People","Category – Product","Category – Place"],s=["Link – Product","Link – Product Family","Link – Product Category","Link – Customer","Link – Customer Segment","Link – Dealer","Link – Employee","Link – Region","Link – Category","Link – MSA","Link – Time","Link – Product Line","Link – Product Type","Link – Sales Representative"],l=["Department – Design/Development","Department – IT","Department – Sales","Department – Marketing","Department – Performance Environments","Department – Product Management","Department – Research"],d="#baff12",u="#feb612",p="#14a2fa",h=function(){var t="data/inventory.csv";queue().defer(d3.csv,t).await(function(t,e){i=e,f()})},f=function(){console.log("finished loading data"),m(),window.location.hash="",window.location.hash="/search",y()},m=function(){console.log("listening page"),$(window).on("hashchange",function(){var t=window.location.hash;$("a").removeClass("selected"),$('a[href="'+t+'"]').addClass("selected"),g(t),y()})},g=function(i){if($("#view").html(""),$("svg").remove(),t&&t.stop(),$(".d3-tip").remove(),"#/search"===i){e="Any",n="Any",a="Any",r="Any";var o=$("#tpl-filter").html(),c=_.template(o);$("#view").html(c),v()}else"#/vis_all"===i&&k("networkgraph.csv")},y=function(){$("#sel_freq_updated").off("change").on("change",function(){e=$(this).val()}),$("#sel_used_by").off("change").on("change",function(){n=$(this).val()}),$("#sel_linked_to").off("change").on("change",function(){a=$(this).val()}),$("#sel_relevant_to").off("change").on("change",function(){r=$(this).val()}),$("#btn_submit").off("click").on("click",function(){v()})},v=function(){$(window).off("resize"),console.log("empty output"),o=[],console.log("filter#1: "+e),console.log("filter#2: "+n),console.log("filter#3: "+a),console.log("filter#4: "+r);var t=[],c=[],s=[],l=[];_.each(i,function(i){"Any"!==e&&i[$("#field_freq_updated").text()]===e?t.push(i):"Any"===e&&t.push(i),"Any"!==n&&i["Used By Department 1"]===n||i["Used By Department 2"]===n||i["Used By Department 3"]===n||i["Used By Department 4"]===n?c.push(i):"Any"===n&&c.push(i),"Any"!==a&&i["Linkable Data 1"]===a||i["Linkable Data 2"]===a||i["Linkable Data 3"]===a?s.push(i):"Any"===a&&s.push(i),"Any"!==r&&"1"===i[r]?l.push(i):"Any"===r&&l.push(i)}),o=_.intersection(t,c,s,l),$("#number_of_resources").html(o.length+" of "+i.length+" Data Resources found");var d=$("#tpl-result").html(),u=_.template(d,{array:o});$("#result_container").html(u),$(".tb_result").fadeIn()},k=function(e){var n=window.innerWidth,a=window.innerHeight,r=$("#tpl-d3").html(),o=_.template(r);$("#view").html(o);var h=d3.select("#view").append("svg").attr("width",n).attr("height",a);t&&t.stop(),t=d3.layout.force().size([n,a]).charge(-300).linkDistance(80),d3.csv("data/vis/"+e,function(e){function n(){m.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),v.attr("cx",function(t){return t.x}).attr("cy",function(t){return t.y}),y.attr({dx:function(t){return t.x+8},dy:function(t){return t.y-10}})}function a(t){return r[t]||(r[t]={name:t})}var r={};e.forEach(function(t){t.source=a(t.source),t.target=a(t.target)});var o=d3.values(r),m=h.selectAll(".link").data(e).enter().append("line").attr({stroke:function(t){return"1"===t.target_type?(d3.select(this).attr({"class":"graph-data link i_cat"}),d):"2"===t.target_type?(d3.select(this).attr({"class":"graph-data link i_dep"}),p):"3"===t.target_type?(d3.select(this).attr({"class":"graph-data link i_link"}),u):"#000"}});$(".d3-tip").remove();var g=d3.tip().attr("class","d3-tip").html(function(t){return i.some(function(e){if(t.name===e.Name){var n=t.name,a=(e["Used By Department 1"],e["Used By Department 2"],e["Used By Department 3"],e["Used By Department 4"],e["Frequency Updated"]);e["Frequency Used"]}console.log(n+"<br>"+a)}),t.name}),y=h.selectAll("g").data(o).enter().append("text").text(function(t){return _.contains(s,t.name)?(d3.select(this).attr({"class":"graph-data text i_link"}),t.name):_.contains(c,t.name)?(d3.select(this).attr({"class":"graph-data text i_cat"}),t.name):_.contains(l,t.name)?(d3.select(this).attr({"class":"graph-data text i_dep"}),t.name):void 0}),v=h.selectAll("g").data(o).enter().append("circle").attr({r:function(t){return _.contains(c,t.name)?(d3.select(this).attr({"class":"graph-data node i_cat"}),10):_.contains(s,t.name)?(d3.select(this).attr({"class":"graph-data node i_link"}),10):_.contains(l,t.name)?(d3.select(this).attr({"class":"graph-data node i_dep"}),10):(d3.select(this).attr({"class":"graph-data node i_genpop"}),3)},fill:function(t){return _.contains(c,t.name)?d:_.contains(l,t.name)?p:_.contains(s,t.name)?u:"#c4c4c4"}}).on("mouseover",g.show).on("mouseout",g.hide).call(t.drag).call(g);t.nodes(o).links(e).on("tick",n).start(),f()}),$(".networkGraphOptionInput").on("change",function(){$(".i_dep").hide(),$(".i_cat").hide(),$(".i_link").hide(),f()});var f=function(){$.each($(".networkGraphOptionInput:checked"),function(t,e){$("."+$(e).val()).show()});var t=$(".graph-data.node");$.each(t,function(){})},m=_.debounce(w,150);$(window).off("resize").on("resize",m)},w=function(){k("networkgraph.csv")};return{init:f,load:h}}(),app.main.load();