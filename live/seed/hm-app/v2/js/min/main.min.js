function customIndexOf(t,e){var n=-1;return _.some(t,function(t,a){return e.toLowerCase().replace(/\u00a0/g," ")===t.Name.toLowerCase().replace(/\u00a0/g," ")?(n=a,!0):!1}),n}var app=app||{};app.main=function(){var t,e,n,a,r,o=[],i=[],s=["Category - People","Category - Product","Category - Place"],c=["Link - Product","Link - Product Family","Link - Product Category","Link - Customer","Link - Customer Segment","Link - Dealer","Link - Employee","Link - Region","Link - Category","Link - MSA","Link - Time","Link â€“ Product Line","Link - Product Type","Link - Sales Representative"],l=["Department - Design/Development","Department - IT","Department - Sales","Department - Marketing","Department - Performance Environments","Department - Product Management","Department - Research"],u=["1","2","3"],d=0,p=0,f=0,h="#baff12",m="#feb612",g="#14a2fa",y=function(){var t="data/inventory.csv";queue().defer(d3.csv,t).await(function(t,e){o=e,v()})},v=function(){console.log("finished loading data"),k(),window.location.hash="",window.location.hash="/inventory",D()},k=function(){console.log("listening page"),$(window).on("hashchange",function(){var t=window.location.hash;$("a").removeClass("selected"),$('a[href="'+t+'"]').addClass("selected"),w(t),D()})},w=function(o){var i,s;$("#view").html(""),$("svg").remove(),t&&t.stop(),$(".d3-tip").remove(),"#/inventory"===o?(e="Any",n="Any",a="Any",r="Any",i=$("#tpl-filter").html(),s=_.template(i),$("#view").html(s),x()):"#/vis_all"===o?(i=$("#tpl-network").html(),s=_.template(i),$("#view").html(s),L("networkgraph.csv",u)):"#/add_dataset"===o&&U()},D=function(){$("#sel_freq_updated").off("change").on("change",function(){e=$(this).val()}),$("#sel_used_by").off("change").on("change",function(){n=$(this).val()}),$("#sel_linked_to").off("change").on("change",function(){a=$(this).val()}),$("#sel_relevant_to").off("change").on("change",function(){r=$(this).val()}),$("#btn_submit").off("click").on("click",function(){x()})},x=function(){$(window).off("resize"),console.log("empty output"),i=[],console.log("filter#1: "+e),console.log("filter#2: "+n),console.log("filter#3: "+a),console.log("filter#4: "+r);var t=[],s=[],c=[],l=[];_.each(o,function(o){"Any"!==e&&o[$("#field_freq_updated").text()]===e?t.push(o):"Any"===e&&t.push(o),"Any"!==n&&o["Used By Department 1"]===n||o["Used By Department 2"]===n||o["Used By Department 3"]===n||o["Used By Department 4"]===n?s.push(o):"Any"===n&&s.push(o),"Any"!==a&&o["Linkable Data 1"]===a||o["Linkable Data 2"]===a||o["Linkable Data 3"]===a?c.push(o):"Any"===a&&c.push(o),"Any"!==r&&"1"===o[r]?l.push(o):"Any"===r&&l.push(o)}),i=_.intersection(t,s,c,l),$("#number_of_resources").html(i.length+" of "+o.length+" Data Resources found");var u=$("#tpl-result").html(),d=_.template(u,{array:i});$("#result_container").html(d),$(".tb_result").fadeIn()},L=function(e){$("svg").remove();var n=window.innerWidth,a=window.innerHeight,r=d3.select("#view").append("svg").attr("width",n).attr("height",a);t&&t.stop(),t=d3.layout.force().size([n,a]).charge(-300).linkDistance(80),d3.csv("data/vis/"+e,function(e){function y(){D.attr("x1",function(t){return t.source.x}).attr("y1",function(t){return t.source.y}).attr("x2",function(t){return t.target.x}).attr("y2",function(t){return t.target.y}),b.attr("cx",function(t){return Math.max(0,Math.min(n,t.x))}).attr("cy",function(t){return Math.max(100,Math.min(a-50,t.y))}),L.attr({dx:function(t){return t.x+8},dy:function(t){return t.y-10}})}function v(t){return k[t.replace(/\u00a0/g," ")]||(k[t.replace(/\u00a0/g," ")]={name:t.replace(/\u00a0/g," ")})}var k={};d=0,console.log(u),e.forEach(function(t){u.forEach(function(e){t.target_type===e&&(t.source=v(t.source),t.target=v(t.target),d+=1)}),3===u.length&&(p=d)});var w=d3.values(k);3===u.length&&(f=w.length),$(".graphStats").html(w.length+" of "+f+" Nodes Displayed<br>"+d+" of "+p+" Edges Displayed");var D=r.selectAll(".link").data(e).enter().append("line").attr({"data-source":function(t){return t.source.name},"data-target":function(t){return t.target.name},stroke:function(t){return"1"===t.target_type?(d3.select(this).attr({"class":"graph-data link"}),h):"2"===t.target_type?(d3.select(this).attr({"class":"graph-data link"}),g):"3"===t.target_type?(d3.select(this).attr({"class":"graph-data link"}),m):"#000"}});$(".d3-tip").remove();var x=d3.tip().attr("class","d3-tip").html(function(t){return t.data_tooltip}),L=r.selectAll("g").data(w).enter().append("text").text(function(t){return _.contains(c,t.name)?(d3.select(this).attr({"class":"graph-data text"}),t.name):_.contains(s,t.name)?(d3.select(this).attr({"class":"graph-data text"}),t.name):_.contains(l,t.name)?(d3.select(this).attr({"class":"graph-data text"}),t.name):void 0}),b=r.selectAll("g").data(w).enter().append("circle").attr({"data-name":function(t){return t.name},r:function(t){return t.data_tooltip=A(t.name),_.contains(s,t.name)?(d3.select(this).attr({"class":"graph-data node"}),12):_.contains(c,t.name)?(d3.select(this).attr({"class":"graph-data node"}),12):_.contains(l,t.name)?(d3.select(this).attr({"class":"graph-data node"}),12):(d3.select(this).attr({"class":"graph-data node"}),4)},fill:function(t){return _.contains(s,t.name)?h:_.contains(l,t.name)?g:_.contains(c,t.name)?m:"#fff"}}).on("mouseover",x.show).on("mouseout",x.hide).call(t.drag).call(x);t.nodes(w).links(e).on("tick",y).friction(.6).start(),o(),i()}),$(".networkGraphOptionInput").off("change").on("change",function(){o(),L("networkgraph.csv",u)});var o=function(){u=[],$.each($(".networkGraphOptionInput:checked"),function(t,e){u.push($(e).val())})},i=function(){$(".node").off("mouseover").on("mouseover",function(){d3.selectAll('.link[data-source="'+$(this).attr("data-name")+'"]').attr({"class":"thickStroke"})}).off("mouseout").on("mouseout",function(){$(".thickStroke").attr({"class":"link"})}),d3.selectAll(".link").on("mouseover",function(){d3.select(this).attr({"class":"thickStroke"})}).on("mouseout",function(){d3.select(this).attr({"class":"link"})})},y=_.debounce(b,150);$(window).off("resize").on("resize",y)},b=function(){L("networkgraph.csv",u)},A=function(t){var e=customIndexOf(o,t);return o[e]?'<span style="font-size: 1.25em; line-height: 1.25em; margin-bottom: 9px">'+o[e].Name+'</span><br><span style="line-height: 1.35em;">Owned by: '+(""!==o[e]["Used By Department 1"]?o[e]["Used By Department 1"]:"")+(""!==o[e]["Used By Department 2"]?", "+o[e]["Used By Department 2"]:"")+(""!==o[e]["Used By Department 3"]?", "+o[e]["Used By Department 3"]:"")+(""!==o[e]["Used By Department 4"]?", "+o[e]["Used By Department 4"]:"")+"<br>Frequency Updated: "+o[e]["Frequency Updated"]+"<br>Frequency Used: "+o[e]["Frequency Used"]+"</span>":t},U=function(){var t=$("#tpl-add-dataset").html(),e=_.template(t),n=$("#view");n.html(e);var a=n.find("form");a.on("submit",function(t){t.preventDefault(),t.returnValue=!1;var e=a.serialize();$.ajax({type:"POST",url:"/updateInventory",data:e}).done(function(){alert("Success!"),window.location.reload()}).fail(function(){alert("Sorry, an error occurred.")})})};return{init:v,load:y}}(),app.main.load();