var app=app||{};app.main=function(){var n,t,e,a,o=[],i=[],r=function(){var n="data/inventory.csv";queue().defer(d3.csv,n).await(function(n,t){o=t,c()})},c=function(){console.log("finished loading data"),l(),window.location.hash="",window.location.hash="/search",u()},l=function(){console.log("listening page"),$(window).on("hashchange",function(){var n=window.location.hash;$("a").removeClass("selected"),$('a[href="'+n+'"]').addClass("selected"),s(n),u()})},s=function(o){if($("#view").html(""),"#/search"===o){n="Any",t="Any",e="Any",a="Any";var i=$("#tpl-filter").html(),r=_.template(i);$("#view").html(r),f()}else"#/vis_ppp"===o?h("ppp.csv"):"#/vis_linkage"===o?h("linkage.csv"):"#/vis_department"===o&&h("department.csv")},u=function(){$("#sel_freq_updated").off("change").on("change",function(){n=$(this).val()}),$("#sel_used_by").off("change").on("change",function(){t=$(this).val()}),$("#sel_linked_to").off("change").on("change",function(){e=$(this).val()}),$("#sel_relevant_to").off("change").on("change",function(){a=$(this).val()}),$("#btn_submit").off("click").on("click",function(){f()})},f=function(){console.log("empty output"),i=[],console.log("filter#1: "+n),console.log("filter#2: "+t),console.log("filter#3: "+e),console.log("filter#4: "+a);var r=[],c=[],l=[],s=[];_.each(o,function(o){"Any"!==n&&o[$("#field_freq_updated").text()]===n?r.push(o):"Any"===n&&r.push(o),"Any"!==t&&o["Used By Department 1"]===t||o["Used By Department 2"]===t||o["Used By Department 3"]===t||o["Used By Department 4"]===t?c.push(o):"Any"===t&&c.push(o),"Any"!==e&&o["Linkable Data 1"]===e||o["Linkable Data 2"]===e||o["Linkable Data 3"]===e?l.push(o):"Any"===e&&l.push(o),"Any"!==a&&"1"===o[a]?s.push(o):"Any"===a&&s.push(o)}),i=_.intersection(r,c,l,s),$("#number_of_resources").html(i.length+" Data Resources found");var u=$("#tpl-result").html(),f=_.template(u,{array:i});$("#result_container").html(f),$(".tb_result").fadeIn()},h=function(n){var t=window.innerWidth,e=window.innerHeight,a=d3.select("#view").append("svg").attr("width",t).attr("height",e),o=d3.layout.force().size([t,e]).charge(-80).linkDistance(70);d3.csv("../data/vis/"+n,function(n){function t(){c.attr("x1",function(n){return n.source.x}).attr("y1",function(n){return n.source.y}).attr("x2",function(n){return n.target.x}).attr("y2",function(n){return n.target.y}),s.attr("cx",function(n){return n.x}).attr("cy",function(n){return n.y}).attr("r",function(n){return n.weight>=4?Math.max(n.weight/20,5):4}).attr("fill",function(n){return n.weight>=4?"hsl(1,75%,50%)":"#000"})}function e(n){return i[n]||(i[n]={name:n})}var i={};n.forEach(function(n){n.source=e(n.source),n.target=e(n.target)});var r=d3.values(i),c=a.selectAll(".link").data(n).enter().append("line").attr("class","link"),l=d3.tip().attr("class","d3-tip").html(function(n){return n.name}),s=a.selectAll(".node").data(r).enter().append("circle").attr({"class":function(){return"node"}}).on("mouseover",l.show).on("mouseout",l.hide).call(o.drag).call(l);o.nodes(r).links(n).on("tick",t).start()})};return{init:c,load:r}}(),app.main.load();